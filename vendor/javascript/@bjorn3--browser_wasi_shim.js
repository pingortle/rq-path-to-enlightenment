const t=0;const e=1;const n=2;const r=0;const s=1;const i=2;const o=3;const _=0;const f=1;const a=2;const c=3;const l=4;const d=5;const u=6;const h=7;const R=8;const E=9;const p=10;const y=11;const N=12;const I=13;const g=14;const T=15;const O=16;const S=17;const A=18;const w=19;const b=20;const m=21;const D=22;const L=23;const U=24;const F=25;const G=26;const C=27;const P=28;const x=29;const v=30;const B=31;const k=32;const H=33;const M=34;const V=35;const Y=36;const j=37;const z=38;const K=39;const W=40;const X=41;const Q=42;const Z=43;const q=44;const J=45;const $=46;const tt=47;const et=48;const nt=49;const rt=50;const st=51;const it=52;const ot=53;const _t=54;const ft=55;const at=56;const ct=57;const lt=58;const dt=59;const ut=60;const ht=61;const Rt=62;const Et=63;const pt=64;const yt=65;const Nt=66;const It=67;const gt=68;const Tt=69;const Ot=70;const St=71;const At=72;const wt=73;const bt=74;const mt=75;const Dt=76;const Lt=1;const Ut=2;const Ft=4;const Gt=8;const Ct=16;const Pt=32;const xt=64;const vt=128;const Bt=256;const kt=512;const Ht=1024;const Mt=2048;const Vt=4096;const Yt=8192;const jt=16384;const zt=32768;const Kt=65536;const Wt=1<<17;const Xt=1<<18;const Qt=1<<19;const Zt=1<<20;const qt=1<<21;const Jt=1<<22;const $t=1<<23;const te=1<<24;const ee=1<<25;const ne=1<<26;const re=1<<27;const se=1<<28;class Iovec{static read_bytes(t,e){const n=new Iovec;n.buf=t.getUint32(e,true);n.buf_len=t.getUint32(e+4,true);return n}static read_bytes_array(t,e,n){const r=[];for(let s=0;s<n;s++)r.push(Iovec.read_bytes(t,e+8*s));return r}}class Ciovec{static read_bytes(t,e){const n=new Ciovec;n.buf=t.getUint32(e,true);n.buf_len=t.getUint32(e+4,true);return n}static read_bytes_array(t,e,n){const r=[];for(let s=0;s<n;s++)r.push(Ciovec.read_bytes(t,e+8*s));return r}}const ie=0;const oe=1;const _e=2;const fe=0;const ae=1;const ce=2;const le=3;const de=4;const ue=5;const he=6;const Re=7;class Dirent{head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(t,e){t.setBigUint64(e,this.d_next,true);t.setBigUint64(e+8,this.d_ino,true);t.setUint32(e+16,this.dir_name.length,true);t.setUint8(e+20,this.d_type)}write_name_bytes(t,e,n){t.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,n)),e)}constructor(t,e,n){this.d_ino=0n;const r=(new TextEncoder).encode(e);this.d_next=t;this.d_namlen=r.byteLength;this.d_type=n;this.dir_name=r}}const Ee=0;const pe=1;const ye=2;const Ne=3;const Ie=4;const ge=5;const Te=1;const Oe=2;const Se=4;const Ae=8;const we=16;class Fdstat{write_bytes(t,e){t.setUint8(e,this.fs_filetype);t.setUint16(e+2,this.fs_flags,true);t.setBigUint64(e+8,this.fs_rights_base,true);t.setBigUint64(e+16,this.fs_rights_inherited,true)}constructor(t,e){this.fs_rights_base=0n;this.fs_rights_inherited=0n;this.fs_filetype=t;this.fs_flags=e}}const be=1;const me=2;const De=4;const Le=8;const Ue=1;const Fe=2;const Ge=4;const Ce=8;class Filestat{write_bytes(t,e){t.setBigUint64(e,this.dev,true);t.setBigUint64(e+8,this.ino,true);t.setUint8(e+16,this.filetype);t.setBigUint64(e+24,this.nlink,true);t.setBigUint64(e+32,this.size,true);t.setBigUint64(e+38,this.atim,true);t.setBigUint64(e+46,this.mtim,true);t.setBigUint64(e+52,this.ctim,true)}constructor(t,e){this.dev=0n;this.ino=0n;this.nlink=0n;this.atim=0n;this.mtim=0n;this.ctim=0n;this.filetype=t;this.size=e}}const Pe=0;const xe=1;const ve=2;const Be=1;const ke=1;const He=0;const Me=1;const Ve=2;const Ye=3;const je=4;const ze=5;const Ke=6;const We=7;const Xe=8;const Qe=9;const Ze=10;const qe=11;const Je=12;const $e=13;const tn=14;const en=15;const nn=16;const rn=17;const sn=18;const on=19;const _n=20;const fn=21;const an=22;const cn=23;const ln=24;const dn=25;const un=26;const hn=27;const Rn=28;const En=29;const pn=30;const yn=1;const Nn=2;const In=1;const gn=1;const Tn=2;const On=0;class PrestatDir{write_bytes(t,e){t.setUint32(e,this.pr_name.byteLength,true)}constructor(t){this.pr_name=(new TextEncoder).encode(t)}}class Prestat{static dir(t){const e=new Prestat;e.tag=On;e.inner=new PrestatDir(t);return e}write_bytes(t,e){t.setUint32(e,this.tag,true);this.inner.write_bytes(t,e+4)}}var Sn=Object.freeze(Object.defineProperty({__proto__:null,ADVICE_DONTNEED:Ie,ADVICE_NOREUSE:ge,ADVICE_NORMAL:Ee,ADVICE_RANDOM:ye,ADVICE_SEQUENTIAL:pe,ADVICE_WILLNEED:Ne,CLOCKID_MONOTONIC:s,CLOCKID_PROCESS_CPUTIME_ID:i,CLOCKID_REALTIME:r,CLOCKID_THREAD_CPUTIME_ID:o,Ciovec:Ciovec,Dirent:Dirent,ERRNO_2BIG:f,ERRNO_ACCES:a,ERRNO_ADDRINUSE:c,ERRNO_ADDRNOTAVAIL:l,ERRNO_AFNOSUPPORT:d,ERRNO_AGAIN:u,ERRNO_ALREADY:h,ERRNO_BADF:R,ERRNO_BADMSG:E,ERRNO_BUSY:p,ERRNO_CANCELED:y,ERRNO_CHILD:N,ERRNO_CONNABORTED:I,ERRNO_CONNREFUSED:g,ERRNO_CONNRESET:T,ERRNO_DEADLK:O,ERRNO_DESTADDRREQ:S,ERRNO_DOM:A,ERRNO_DQUOT:w,ERRNO_EXIST:b,ERRNO_FAULT:m,ERRNO_FBIG:D,ERRNO_HOSTUNREACH:L,ERRNO_IDRM:U,ERRNO_ILSEQ:F,ERRNO_INPROGRESS:G,ERRNO_INTR:C,ERRNO_INVAL:P,ERRNO_IO:x,ERRNO_ISCONN:v,ERRNO_ISDIR:B,ERRNO_LOOP:k,ERRNO_MFILE:H,ERRNO_MLINK:M,ERRNO_MSGSIZE:V,ERRNO_MULTIHOP:Y,ERRNO_NAMETOOLONG:j,ERRNO_NETDOWN:z,ERRNO_NETRESET:K,ERRNO_NETUNREACH:W,ERRNO_NFILE:X,ERRNO_NOBUFS:Q,ERRNO_NODEV:Z,ERRNO_NOENT:q,ERRNO_NOEXEC:J,ERRNO_NOLCK:$,ERRNO_NOLINK:tt,ERRNO_NOMEM:et,ERRNO_NOMSG:nt,ERRNO_NOPROTOOPT:rt,ERRNO_NOSPC:st,ERRNO_NOSYS:it,ERRNO_NOTCAPABLE:Dt,ERRNO_NOTCONN:ot,ERRNO_NOTDIR:_t,ERRNO_NOTEMPTY:ft,ERRNO_NOTRECOVERABLE:at,ERRNO_NOTSOCK:ct,ERRNO_NOTSUP:lt,ERRNO_NOTTY:dt,ERRNO_NXIO:ut,ERRNO_OVERFLOW:ht,ERRNO_OWNERDEAD:Rt,ERRNO_PERM:Et,ERRNO_PIPE:pt,ERRNO_PROTO:yt,ERRNO_PROTONOSUPPORT:Nt,ERRNO_PROTOTYPE:It,ERRNO_RANGE:gt,ERRNO_ROFS:Tt,ERRNO_SPIPE:Ot,ERRNO_SRCH:St,ERRNO_STALE:At,ERRNO_SUCCESS:_,ERRNO_TIMEDOUT:wt,ERRNO_TXTBSY:bt,ERRNO_XDEV:mt,EVENTRWFLAGS_FD_READWRITE_HANGUP:Be,EVENTTYPE_CLOCK:Pe,EVENTTYPE_FD_READ:xe,EVENTTYPE_FD_WRITE:ve,FDFLAGS_APPEND:Te,FDFLAGS_DSYNC:Oe,FDFLAGS_NONBLOCK:Se,FDFLAGS_RSYNC:Ae,FDFLAGS_SYNC:we,FD_STDERR:n,FD_STDIN:t,FD_STDOUT:e,FILETYPE_BLOCK_DEVICE:ae,FILETYPE_CHARACTER_DEVICE:ce,FILETYPE_DIRECTORY:le,FILETYPE_REGULAR_FILE:de,FILETYPE_SOCKET_DGRAM:ue,FILETYPE_SOCKET_STREAM:he,FILETYPE_SYMBOLIC_LINK:Re,FILETYPE_UNKNOWN:fe,FSTFLAGS_ATIM:be,FSTFLAGS_ATIM_NOW:me,FSTFLAGS_MTIM:De,FSTFLAGS_MTIM_NOW:Le,Fdstat:Fdstat,Filestat:Filestat,Iovec:Iovec,OFLAGS_CREAT:Ue,OFLAGS_DIRECTORY:Fe,OFLAGS_EXCL:Ge,OFLAGS_TRUNC:Ce,PREOPENTYPE_DIR:On,Prestat:Prestat,PrestatDir:PrestatDir,RIFLAGS_RECV_PEEK:yn,RIFLAGS_RECV_WAITALL:Nn,RIGHTS_FD_ADVISE:vt,RIGHTS_FD_ALLOCATE:Bt,RIGHTS_FD_DATASYNC:Lt,RIGHTS_FD_FDSTAT_SET_FLAGS:Gt,RIGHTS_FD_FILESTAT_GET:qt,RIGHTS_FD_FILESTAT_SET_SIZE:Jt,RIGHTS_FD_FILESTAT_SET_TIMES:$t,RIGHTS_FD_READ:Ut,RIGHTS_FD_READDIR:jt,RIGHTS_FD_SEEK:Ft,RIGHTS_FD_SYNC:Ct,RIGHTS_FD_TELL:Pt,RIGHTS_FD_WRITE:xt,RIGHTS_PATH_CREATE_DIRECTORY:kt,RIGHTS_PATH_CREATE_FILE:Ht,RIGHTS_PATH_FILESTAT_GET:Xt,RIGHTS_PATH_FILESTAT_SET_SIZE:Qt,RIGHTS_PATH_FILESTAT_SET_TIMES:Zt,RIGHTS_PATH_LINK_SOURCE:Mt,RIGHTS_PATH_LINK_TARGET:Vt,RIGHTS_PATH_OPEN:Yt,RIGHTS_PATH_READLINK:zt,RIGHTS_PATH_REMOVE_DIRECTORY:ee,RIGHTS_PATH_RENAME_SOURCE:Kt,RIGHTS_PATH_RENAME_TARGET:Wt,RIGHTS_PATH_SYMLINK:te,RIGHTS_PATH_UNLINK_FILE:ne,RIGHTS_POLL_FD_READWRITE:re,RIGHTS_SOCK_SHUTDOWN:se,ROFLAGS_RECV_DATA_TRUNCATED:In,SDFLAGS_RD:gn,SDFLAGS_WR:Tn,SIGNAL_ABRT:Ke,SIGNAL_ALRM:tn,SIGNAL_BUS:We,SIGNAL_CHLD:nn,SIGNAL_CONT:rn,SIGNAL_FPE:Xe,SIGNAL_HUP:Me,SIGNAL_ILL:je,SIGNAL_INT:Ve,SIGNAL_KILL:Qe,SIGNAL_NONE:He,SIGNAL_PIPE:$e,SIGNAL_POLL:Rn,SIGNAL_PROF:un,SIGNAL_PWR:En,SIGNAL_QUIT:Ye,SIGNAL_SEGV:qe,SIGNAL_STOP:sn,SIGNAL_SYS:pn,SIGNAL_TERM:en,SIGNAL_TRAP:ze,SIGNAL_TSTP:on,SIGNAL_TTIN:_n,SIGNAL_TTOU:fn,SIGNAL_URG:an,SIGNAL_USR1:Ze,SIGNAL_USR2:Je,SIGNAL_VTALRM:dn,SIGNAL_WINCH:hn,SIGNAL_XCPU:cn,SIGNAL_XFSZ:ln,SUBCLOCKFLAGS_SUBSCRIPTION_CLOCK_ABSTIME:ke,WHENCE_CUR:oe,WHENCE_END:_e,WHENCE_SET:ie},Symbol.toStringTag,{value:"Module"}));let An=class Debug{enable(t){this.log=createLogger(t===void 0||t,this.prefix)}get enabled(){return this.isEnabled}constructor(t){this.isEnabled=t;this.prefix="wasi:";this.enable(t)}};function createLogger(t,e){if(t){const t=console.log.bind(console,"%c%s","color: #265BA0",e);return t}return()=>{}}const wn=new An(false);class WASIProcExit extends Error{constructor(t){super("exit with exit code "+t);this.code=t}}let bn=class WASI{start(t){this.inst=t;try{t.exports._start();return 0}catch(t){if(t instanceof WASIProcExit)return t.code;throw t}}initialize(t){this.inst=t;t.exports._initialize&&t.exports._initialize()}constructor(t,e,n,i={}){this.args=[];this.env=[];this.fds=[];wn.enable(i.debug);this.args=t;this.env=e;this.fds=n;const o=this;this.wasiImport={args_sizes_get(t,e){const n=new DataView(o.inst.exports.memory.buffer);n.setUint32(t,o.args.length,true);let r=0;for(const t of o.args)r+=t.length+1;n.setUint32(e,r,true);wn.log(n.getUint32(t,true),n.getUint32(e,true));return 0},args_get(t,e){const n=new DataView(o.inst.exports.memory.buffer);const r=new Uint8Array(o.inst.exports.memory.buffer);const s=e;for(let s=0;s<o.args.length;s++){n.setUint32(t,e,true);t+=4;const i=(new TextEncoder).encode(o.args[s]);r.set(i,e);n.setUint8(e+i.length,0);e+=i.length+1}wn.enabled&&wn.log(new TextDecoder("utf-8").decode(r.slice(s,e)));return 0},environ_sizes_get(t,e){const n=new DataView(o.inst.exports.memory.buffer);n.setUint32(t,o.env.length,true);let r=0;for(const t of o.env)r+=t.length+1;n.setUint32(e,r,true);wn.log(n.getUint32(t,true),n.getUint32(e,true));return 0},environ_get(t,e){const n=new DataView(o.inst.exports.memory.buffer);const r=new Uint8Array(o.inst.exports.memory.buffer);const s=e;for(let s=0;s<o.env.length;s++){n.setUint32(t,e,true);t+=4;const i=(new TextEncoder).encode(o.env[s]);r.set(i,e);n.setUint8(e+i.length,0);e+=i.length+1}wn.enabled&&wn.log(new TextDecoder("utf-8").decode(r.slice(s,e)));return 0},clock_res_get(t,e){let n;switch(t){case s:n=5000n;break;case r:n=1000000n;break;default:return it}const i=new DataView(o.inst.exports.memory.buffer);i.setBigUint64(e,n,true);return _},clock_time_get(t,e,n){const i=new DataView(o.inst.exports.memory.buffer);if(t===r)i.setBigUint64(n,BigInt((new Date).getTime())*1000000n,true);else if(t==s){let t;try{t=BigInt(Math.round(performance.now()*1e6))}catch(e){t=0n}i.setBigUint64(n,t,true)}else i.setBigUint64(n,0n,true);return 0},fd_advise(t,e,n,r){return o.fds[t]!=void 0?_:R},fd_allocate(t,e,n){return o.fds[t]!=void 0?o.fds[t].fd_allocate(e,n):R},fd_close(t){if(o.fds[t]!=void 0){const e=o.fds[t].fd_close();o.fds[t]=void 0;return e}return R},fd_datasync(t){return o.fds[t]!=void 0?o.fds[t].fd_sync():R},fd_fdstat_get(t,e){if(o.fds[t]!=void 0){const{ret:n,fdstat:r}=o.fds[t].fd_fdstat_get();r!=null&&r.write_bytes(new DataView(o.inst.exports.memory.buffer),e);return n}return R},fd_fdstat_set_flags(t,e){return o.fds[t]!=void 0?o.fds[t].fd_fdstat_set_flags(e):R},fd_fdstat_set_rights(t,e,n){return o.fds[t]!=void 0?o.fds[t].fd_fdstat_set_rights(e,n):R},fd_filestat_get(t,e){if(o.fds[t]!=void 0){const{ret:n,filestat:r}=o.fds[t].fd_filestat_get();r!=null&&r.write_bytes(new DataView(o.inst.exports.memory.buffer),e);return n}return R},fd_filestat_set_size(t,e){return o.fds[t]!=void 0?o.fds[t].fd_filestat_set_size(e):R},fd_filestat_set_times(t,e,n,r){return o.fds[t]!=void 0?o.fds[t].fd_filestat_set_times(e,n,r):R},fd_pread(t,e,n,r,s){const i=new DataView(o.inst.exports.memory.buffer);const f=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const a=Iovec.read_bytes_array(i,e,n);let c=0;for(const e of a){const{ret:n,data:a}=o.fds[t].fd_pread(e.buf_len,r);if(n!=_){i.setUint32(s,c,true);return n}f.set(a,e.buf);c+=a.length;r+=BigInt(a.length);if(a.length!=e.buf_len)break}i.setUint32(s,c,true);return _}return R},fd_prestat_get(t,e){const n=new DataView(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const{ret:r,prestat:s}=o.fds[t].fd_prestat_get();s!=null&&s.write_bytes(n,e);return r}return R},fd_prestat_dir_name(t,e,n){if(o.fds[t]!=void 0){const{ret:r,prestat:s}=o.fds[t].fd_prestat_get();if(s==null)return r;const i=s.inner.pr_name;const f=new Uint8Array(o.inst.exports.memory.buffer);f.set(i.slice(0,n),e);return i.byteLength>n?j:_}return R},fd_pwrite(t,e,n,r,s){const i=new DataView(o.inst.exports.memory.buffer);const f=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const a=Ciovec.read_bytes_array(i,e,n);let c=0;for(const e of a){const n=f.slice(e.buf,e.buf+e.buf_len);const{ret:a,nwritten:l}=o.fds[t].fd_pwrite(n,r);if(a!=_){i.setUint32(s,c,true);return a}c+=l;r+=BigInt(l);if(l!=n.byteLength)break}i.setUint32(s,c,true);return _}return R},fd_read(t,e,n,r){const s=new DataView(o.inst.exports.memory.buffer);const i=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const f=Iovec.read_bytes_array(s,e,n);let a=0;for(const e of f){const{ret:n,data:f}=o.fds[t].fd_read(e.buf_len);if(n!=_){s.setUint32(r,a,true);return n}i.set(f,e.buf);a+=f.length;if(f.length!=e.buf_len)break}s.setUint32(r,a,true);return _}return R},fd_readdir(t,e,n,r,s){const i=new DataView(o.inst.exports.memory.buffer);const _=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){let f=0;while(true){const{ret:a,dirent:c}=o.fds[t].fd_readdir_single(r);if(a!=0){i.setUint32(s,f,true);return a}if(c==null)break;if(n-f<c.head_length()){f=n;break}const l=new ArrayBuffer(c.head_length());c.write_head_bytes(new DataView(l),0);_.set(new Uint8Array(l).slice(0,Math.min(l.byteLength,n-f)),e);e+=c.head_length();f+=c.head_length();if(n-f<c.name_length()){f=n;break}c.write_name_bytes(_,e,n-f);e+=c.name_length();f+=c.name_length();r=c.d_next}i.setUint32(s,f,true);return 0}return R},fd_renumber(t,e){if(o.fds[t]!=void 0&&o.fds[e]!=void 0){const n=o.fds[e].fd_close();if(n!=0)return n;o.fds[e]=o.fds[t];o.fds[t]=void 0;return 0}return R},fd_seek(t,e,n,r){const s=new DataView(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const{ret:i,offset:_}=o.fds[t].fd_seek(e,n);s.setBigInt64(r,_,true);return i}return R},fd_sync(t){return o.fds[t]!=void 0?o.fds[t].fd_sync():R},fd_tell(t,e){const n=new DataView(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const{ret:r,offset:s}=o.fds[t].fd_tell();n.setBigUint64(e,s,true);return r}return R},fd_write(t,e,n,r){const s=new DataView(o.inst.exports.memory.buffer);const i=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const f=Ciovec.read_bytes_array(s,e,n);let a=0;for(const e of f){const n=i.slice(e.buf,e.buf+e.buf_len);const{ret:f,nwritten:c}=o.fds[t].fd_write(n);if(f!=_){s.setUint32(r,a,true);return f}a+=c;if(c!=n.byteLength)break}s.setUint32(r,a,true);return _}return R},path_create_directory(t,e,n){const r=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const s=new TextDecoder("utf-8").decode(r.slice(e,e+n));return o.fds[t].path_create_directory(s)}return R},path_filestat_get(t,e,n,r,s){const i=new DataView(o.inst.exports.memory.buffer);const _=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const f=new TextDecoder("utf-8").decode(_.slice(n,n+r));const{ret:a,filestat:c}=o.fds[t].path_filestat_get(e,f);c!=null&&c.write_bytes(i,s);return a}return R},path_filestat_set_times(t,e,n,r,s,i,_){const f=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const a=new TextDecoder("utf-8").decode(f.slice(n,n+r));return o.fds[t].path_filestat_set_times(e,a,s,i,_)}return R},path_link(t,e,n,r,s,i,_){const f=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0&&o.fds[s]!=void 0){const a=new TextDecoder("utf-8").decode(f.slice(n,n+r));const c=new TextDecoder("utf-8").decode(f.slice(i,i+_));const{ret:l,inode_obj:d}=o.fds[t].path_lookup(a,e);return d==null?l:o.fds[s].path_link(c,d,false)}return R},path_open(t,e,n,r,s,i,_,f,a){const c=new DataView(o.inst.exports.memory.buffer);const l=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const d=new TextDecoder("utf-8").decode(l.slice(n,n+r));wn.log(d);const{ret:u,fd_obj:h}=o.fds[t].path_open(e,d,s,i,_,f);if(u!=0)return u;o.fds.push(h);const R=o.fds.length-1;c.setUint32(a,R,true);return 0}return R},path_readlink(t,e,n,r,s,i){const _=new DataView(o.inst.exports.memory.buffer);const f=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const a=new TextDecoder("utf-8").decode(f.slice(e,e+n));wn.log(a);const{ret:c,data:l}=o.fds[t].path_readlink(a);if(l!=null){const t=(new TextEncoder).encode(l);if(t.length>s){_.setUint32(i,0,true);return R}f.set(t,r);_.setUint32(i,t.length,true)}return c}return R},path_remove_directory(t,e,n){const r=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const s=new TextDecoder("utf-8").decode(r.slice(e,e+n));return o.fds[t].path_remove_directory(s)}return R},path_rename(t,e,n,r,s,i){const f=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0&&o.fds[r]!=void 0){const a=new TextDecoder("utf-8").decode(f.slice(e,e+n));const c=new TextDecoder("utf-8").decode(f.slice(s,s+i));let{ret:l,inode_obj:d}=o.fds[t].path_unlink(a);if(d==null)return l;l=o.fds[r].path_link(c,d,true);if(l!=_&&o.fds[t].path_link(a,d,true)!=_)throw"path_link should always return success when relinking an inode back to the original place";return l}return R},path_symlink(t,e,n,r,s){const i=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[n]!=void 0){new TextDecoder("utf-8").decode(i.slice(t,t+e));new TextDecoder("utf-8").decode(i.slice(r,r+s));return lt}return R},path_unlink_file(t,e,n){const r=new Uint8Array(o.inst.exports.memory.buffer);if(o.fds[t]!=void 0){const s=new TextDecoder("utf-8").decode(r.slice(e,e+n));return o.fds[t].path_unlink_file(s)}return R},poll_oneoff(t,e,n){throw"async io not supported"},proc_exit(t){throw new WASIProcExit(t)},proc_raise(t){throw"raised signal "+t},sched_yield(){},random_get(t,e){const n=new Uint8Array(o.inst.exports.memory.buffer);for(let r=0;r<e;r++)n[t+r]=Math.random()*256|0},sock_recv(t,e,n){throw"sockets not supported"},sock_send(t,e,n){throw"sockets not supported"},sock_shutdown(t,e){throw"sockets not supported"},sock_accept(t,e){throw"sockets not supported"}}}};class Fd{fd_allocate(t,e){return lt}fd_close(){return 0}fd_fdstat_get(){return{ret:lt,fdstat:null}}fd_fdstat_set_flags(t){return lt}fd_fdstat_set_rights(t,e){return lt}fd_filestat_get(){return{ret:lt,filestat:null}}fd_filestat_set_size(t){return lt}fd_filestat_set_times(t,e,n){return lt}fd_pread(t,e){return{ret:lt,data:new Uint8Array}}fd_prestat_get(){return{ret:lt,prestat:null}}fd_pwrite(t,e){return{ret:lt,nwritten:0}}fd_read(t){return{ret:lt,data:new Uint8Array}}fd_readdir_single(t){return{ret:lt,dirent:null}}fd_seek(t,e){return{ret:lt,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:lt,offset:0n}}fd_write(t){return{ret:lt,nwritten:0}}path_create_directory(t){return lt}path_filestat_get(t,e){return{ret:lt,filestat:null}}path_filestat_set_times(t,e,n,r,s){return lt}path_link(t,e,n){return lt}path_unlink(t){return{ret:lt,inode_obj:null}}path_lookup(t,e){return{ret:lt,inode_obj:null}}path_open(t,e,n,r,s,i){return{ret:_t,fd_obj:null}}path_readlink(t){return{ret:lt,data:null}}path_remove_directory(t){return lt}path_rename(t,e,n){return lt}path_unlink_file(t){return lt}}class Inode{}class OpenFile extends Fd{fd_allocate(t,e){if(this.file.size>t+e);else{const n=new Uint8Array(Number(t+e));n.set(this.file.data,0);this.file.data=n}return _}fd_fdstat_get(){return{ret:0,fdstat:new Fdstat(de,0)}}fd_filestat_set_size(t){if(this.file.size>t)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(t)));else{const e=new Uint8Array(Number(t));e.set(this.file.data,0);this.file.data=e}return _}fd_read(t){const e=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(t)));this.file_pos+=BigInt(e.length);return{ret:0,data:e}}fd_pread(t,e){const n=this.file.data.slice(Number(e),Number(e+BigInt(t)));return{ret:0,data:n}}fd_seek(t,e){let n;switch(e){case ie:n=t;break;case oe:n=this.file_pos+t;break;case _e:n=BigInt(this.file.data.byteLength)+t;break;default:return{ret:P,offset:0n}}if(n<0)return{ret:P,offset:0n};this.file_pos=n;return{ret:0,offset:this.file_pos}}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(t){if(this.file.readonly)return{ret:R,nwritten:0};if(this.file_pos+BigInt(t.byteLength)>this.file.size){const e=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(t.byteLength)));this.file.data.set(e)}this.file.data.set(t,Number(this.file_pos));this.file_pos+=BigInt(t.byteLength);return{ret:0,nwritten:t.byteLength}}fd_pwrite(t,e){if(this.file.readonly)return{ret:R,nwritten:0};if(e+BigInt(t.byteLength)>this.file.size){const n=this.file.data;this.file.data=new Uint8Array(Number(e+BigInt(t.byteLength)));this.file.data.set(n)}this.file.data.set(t,Number(e));return{ret:0,nwritten:t.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(t){super();this.file_pos=0n;this.file=t}}class OpenDirectory extends Fd{fd_seek(t,e){return{ret:R,offset:0n}}fd_tell(){return{ret:R,offset:0n}}fd_allocate(t,e){return R}fd_fdstat_get(){return{ret:0,fdstat:new Fdstat(le,0)}}fd_readdir_single(t){if(wn.enabled){wn.log("readdir_single",t);wn.log(t,this.dir.contents.keys())}if(t==0n)return{ret:_,dirent:new Dirent(1n,".",le)};if(t==1n)return{ret:_,dirent:new Dirent(2n,"..",le)};if(t>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[e,n]=Array.from(this.dir.contents.entries())[Number(t-2n)];return{ret:0,dirent:new Dirent(t+1n,e,n.stat().filetype)}}path_filestat_get(t,e){const{ret:n,path:r}=mn.from(e);if(r==null)return{ret:n,filestat:null};const{ret:s,entry:i}=this.dir.get_entry_for_path(r);return i==null?{ret:s,filestat:null}:{ret:0,filestat:i.stat()}}path_lookup(t,e){const{ret:n,path:r}=mn.from(t);if(r==null)return{ret:n,inode_obj:null};const{ret:s,entry:i}=this.dir.get_entry_for_path(r);return i==null?{ret:s,inode_obj:null}:{ret:_,inode_obj:i}}path_open(t,e,n,r,s,i){const{ret:o,path:_}=mn.from(e);if(_==null)return{ret:o,fd_obj:null};let{ret:f,entry:a}=this.dir.get_entry_for_path(_);if(a==null){if(f!=q)return{ret:f,fd_obj:null};if((n&Ue)!=Ue)return{ret:q,fd_obj:null};{const{ret:t,entry:r}=this.dir.create_entry_for_path(e,(n&Fe)==Fe);if(r==null)return{ret:t,fd_obj:null};a=r}}else if((n&Ge)==Ge)return{ret:b,fd_obj:null};return(n&Fe)==Fe&&a.stat().filetype!==le?{ret:_t,fd_obj:null}:a.path_open(n,r,i)}path_create_directory(t){return this.path_open(0,t,Ue|Fe,0n,0n,0).ret}path_link(t,e,n){const{ret:r,path:s}=mn.from(t);if(s==null)return r;if(s.is_dir)return q;const{ret:i,parent_entry:o,filename:f,entry:a}=this.dir.get_parent_dir_and_entry_for_path(s,true);if(o==null||f==null)return i;if(a!=null){const t=e.stat().filetype==le;const r=a.stat().filetype==le;if(t&&r){if(!(n&&a instanceof Directory))return b;if(a.contents.size!=0)return ft}else{if(t&&!r)return _t;if(!t&&r)return B;if(e.stat().filetype!=de||a.stat().filetype!=de)return b}}if(!n&&e.stat().filetype==le)return Et;o.contents.set(f,e);return _}path_unlink(t){const{ret:e,path:n}=mn.from(t);if(n==null)return{ret:e,inode_obj:null};const{ret:r,parent_entry:s,filename:i,entry:o}=this.dir.get_parent_dir_and_entry_for_path(n,true);if(s==null||i==null)return{ret:r,inode_obj:null};if(o==null)return{ret:q,inode_obj:null};s.contents.delete(i);return{ret:_,inode_obj:o}}path_unlink_file(t){const{ret:e,path:n}=mn.from(t);if(n==null)return e;const{ret:r,parent_entry:s,filename:i,entry:o}=this.dir.get_parent_dir_and_entry_for_path(n,false);if(s==null||i==null||o==null)return r;if(o.stat().filetype===le)return B;s.contents.delete(i);return _}path_remove_directory(t){const{ret:e,path:n}=mn.from(t);if(n==null)return e;const{ret:r,parent_entry:s,filename:i,entry:o}=this.dir.get_parent_dir_and_entry_for_path(n,false);return s==null||i==null||o==null?r:o instanceof Directory&&o.stat().filetype===le?o.contents.size!==0?ft:s.contents.delete(i)?_:q:_t}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(t){return R}fd_read(t){return{ret:R,data:new Uint8Array}}fd_pread(t,e){return{ret:R,data:new Uint8Array}}fd_write(t){return{ret:R,nwritten:0}}fd_pwrite(t,e){return{ret:R,nwritten:0}}constructor(t){super();this.dir=t}}class PreopenDirectory extends OpenDirectory{fd_prestat_get(){return{ret:0,prestat:Prestat.dir(this.prestat_name)}}constructor(t,e){super(new Directory(e));this.prestat_name=t}}class File extends Inode{path_open(t,e,n){if(this.readonly&&(e&BigInt(xt))==BigInt(xt))return{ret:Et,fd_obj:null};if((t&Ce)==Ce){if(this.readonly)return{ret:Et,fd_obj:null};this.data=new Uint8Array([])}const r=new OpenFile(this);n&Te&&r.fd_seek(0n,_e);return{ret:_,fd_obj:r}}get size(){return BigInt(this.data.byteLength)}stat(){return new Filestat(de,this.size)}constructor(t,e){super();this.data=new Uint8Array(t);this.readonly=!!e?.readonly}}let mn=class Path{static from(t){const e=new Path;e.is_dir=t.endsWith("/");if(t.startsWith("/"))return{ret:Dt,path:null};if(t.includes("\0"))return{ret:P,path:null};for(const n of t.split("/"))if(n!==""&&n!==".")if(n!=="..")e.parts.push(n);else if(e.parts.pop()==void 0)return{ret:Dt,path:null};return{ret:_,path:e}}to_path_string(){let t=this.parts.join("/");this.is_dir&&(t+="/");return t}constructor(){this.parts=[];this.is_dir=false}};class Directory extends Inode{path_open(t,e,n){return{ret:_,fd_obj:new OpenDirectory(this)}}stat(){return new Filestat(le,0n)}get_entry_for_path(t){let e=this;for(const n of t.parts){if(!(e instanceof Directory))return{ret:_t,entry:null};const t=e.contents.get(n);if(t===void 0){wn.log(n);return{ret:q,entry:null}}e=t}return t.is_dir&&e.stat().filetype!=le?{ret:_t,entry:null}:{ret:_,entry:e}}get_parent_dir_and_entry_for_path(t,e){const n=t.parts.pop();if(n===void 0)return{ret:P,parent_entry:null,filename:null,entry:null};const{ret:r,entry:s}=this.get_entry_for_path(t);if(s==null)return{ret:r,parent_entry:null,filename:null,entry:null};if(!(s instanceof Directory))return{ret:_t,parent_entry:null,filename:null,entry:null};const i=s.contents.get(n);return i===void 0?e?{ret:_,parent_entry:s,filename:n,entry:null}:{ret:q,parent_entry:null,filename:null,entry:null}:t.is_dir&&i.stat().filetype!=le?{ret:_t,parent_entry:null,filename:null,entry:null}:{ret:_,parent_entry:s,filename:n,entry:i}}create_entry_for_path(t,e){const{ret:n,path:r}=mn.from(t);if(r==null)return{ret:n,entry:null};let{ret:s,parent_entry:i,filename:o,entry:f}=this.get_parent_dir_and_entry_for_path(r,true);if(i==null||o==null)return{ret:s,entry:null};if(f!=null)return{ret:b,entry:null};wn.log("create",r);let a;a=e?new Directory(new Map):new File(new ArrayBuffer(0));i.contents.set(o,a);f=a;return{ret:_,entry:f}}constructor(t){super();this.contents=t instanceof Array?new Map(t):t}}class ConsoleStdout extends Fd{fd_filestat_get(){const t=new Filestat(ce,BigInt(0));return{ret:0,filestat:t}}fd_fdstat_get(){const t=new Fdstat(ce,0);t.fs_rights_base=BigInt(xt);return{ret:0,fdstat:t}}fd_write(t){this.write(t);return{ret:0,nwritten:t.byteLength}}static lineBuffered(t){const e=new TextDecoder("utf-8",{fatal:false});let n="";return new ConsoleStdout((r=>{n+=e.decode(r,{stream:true});const s=n.split("\n");for(const[e,r]of s.entries())e<s.length-1?t(r):n=r}))}constructor(t){super();this.write=t}}class SyncOPFSFile extends Inode{path_open(t,e,n){if(this.readonly&&(e&BigInt(xt))==BigInt(xt))return{ret:Et,fd_obj:null};if((t&Ce)==Ce){if(this.readonly)return{ret:Et,fd_obj:null};this.handle.truncate(0)}const r=new OpenSyncOPFSFile(this);n&Te&&r.fd_seek(0n,_e);return{ret:_,fd_obj:r}}get size(){return BigInt(this.handle.getSize())}stat(){return new Filestat(de,this.size)}constructor(t,e){super();this.handle=t;this.readonly=!!e?.readonly}}class OpenSyncOPFSFile extends Fd{fd_allocate(t,e){BigInt(this.file.handle.getSize())>t+e||this.file.handle.truncate(Number(t+e));return _}fd_fdstat_get(){return{ret:0,fdstat:new Fdstat(de,0)}}fd_filestat_get(){return{ret:0,filestat:new Filestat(de,BigInt(this.file.handle.getSize()))}}fd_filestat_set_size(t){this.file.handle.truncate(Number(t));return _}fd_read(t){const e=new Uint8Array(t);const n=this.file.handle.read(e,{at:Number(this.position)});this.position+=BigInt(n);return{ret:0,data:e.slice(0,n)}}fd_seek(t,e){let n;switch(e){case ie:n=BigInt(t);break;case oe:n=this.position+BigInt(t);break;case _e:n=BigInt(this.file.handle.getSize())+BigInt(t);break;default:return{ret:P,offset:0n}}if(n<0)return{ret:P,offset:0n};this.position=n;return{ret:_,offset:this.position}}fd_write(t){if(this.file.readonly)return{ret:R,nwritten:0};const e=this.file.handle.write(t,{at:Number(this.position)});this.position+=BigInt(e);return{ret:_,nwritten:e}}fd_sync(){this.file.handle.flush();return _}constructor(t){super();this.position=0n;this.file=t}}function strace(t,e){return new Proxy(t,{get(t,n,r){const s=Reflect.get(t,n,r);return e.includes(n)?s:function(...t){console.log(n,"(",...t,")");const e=Reflect.apply(s,r,t);console.log(" =",e);return e}}})}export{ConsoleStdout,Directory,Fd,File,Inode,OpenDirectory,OpenFile,OpenSyncOPFSFile,PreopenDirectory,SyncOPFSFile,bn as WASI,WASIProcExit,strace,Sn as wasi};

